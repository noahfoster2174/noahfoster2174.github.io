name: Fetch Strava Activities

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get Strava access token
        id: token
        env:
          STRAVA_CLIENT_ID: ${{ secrets.STRAVA_CLIENT_ID }}
          STRAVA_CLIENT_SECRET: ${{ secrets.STRAVA_CLIENT_SECRET }}
          STRAVA_REFRESH_TOKEN: ${{ secrets.STRAVA_REFRESH_TOKEN }}
        run: |
          RESPONSE=$(curl -s -X POST https://www.strava.com/oauth/token \
            -d "client_id=$STRAVA_CLIENT_ID" \
            -d "client_secret=$STRAVA_CLIENT_SECRET" \
            -d "grant_type=refresh_token" \
            -d "refresh_token=$STRAVA_REFRESH_TOKEN")
          TOKEN=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])")
          echo "access_token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Fetch and filter run activities
        env:
          ACCESS_TOKEN: ${{ steps.token.outputs.access_token }}
        run: |
          curl -s "https://www.strava.com/api/v3/athlete/activities?per_page=10" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            | python3 -c "
          import sys, json
          activities = json.load(sys.stdin)
          keep_keys = ['name', 'distance', 'moving_time', 'start_date_local', 'type']
          runs = []
          for a in activities:
            if a.get('type') == 'Run':
              entry = {k: a[k] for k in keep_keys if k in a}
              entry['polyline'] = a.get('map', {}).get('summary_polyline', '')
              runs.append(entry)
          print(json.dumps(runs[:5], indent=2))
          " > strava.json

      - name: Commit if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add strava.json
          git diff --cached --quiet || git commit -m "chore: update strava activity data"
          git push
